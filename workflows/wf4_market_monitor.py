#!/usr/bin/env python3
"""
工作流 4：二级市场监控
频率：每日（交易日）
关注：美股、港股、A股，全球重点政治经济动态
"""
import sys, os
sys.path.insert(0, os.path.dirname(__file__))
from mbb_report_engine import *
from datetime import datetime

DATE = datetime.now().strftime("%Y%m%d")
DATE_DISPLAY = datetime.now().strftime("%Y.%m.%d")

# 二级市场专属配色
MKT_GREEN = HexColor('#06d6a0')  # 涨
MKT_RED = HexColor('#ef476f')    # 跌
MKT_BLUE = HexColor('#118ab2')   # 中性
MKT_GOLD = HexColor('#ffd166')   # 关注


def generate(news_data=None):

    filename = f"二级市场监控-每日速递-{DATE}.pdf"
    r = MBBReportEngine(
        filename,
        title="\u4e8c\u7ea7\u5e02\u573a\u76d1\u63a7",
        subtitle=f"\u7f8e\u80a1 \u00b7 \u6e2f\u80a1 \u00b7 A\u80a1 \u00b7 \u5168\u7403\u653f\u7ecf\u52a8\u6001  |  {DATE_DISPLAY}",
        accent_color=MKT_BLUE,
        page_scale=5.0
    )

    r.draw_header()

    # ── 大盘指数总览 ──
    r.draw_section_title("\u5927\u76d8\u6307\u6570\u603b\u89c8", MKT_BLUE)

    us_market = news_data.get('us_market', []) if news_data else [
        ("道琼斯", "49,625.97", "+0.47%", MKT_GREEN),
        ("纳斯达克", "22,886.07", "+0.90%", MKT_GREEN),
        ("标普 500", "6,909.51", "+0.69%", MKT_GREEN),
    ]
    r.draw_info_card("美股主要指数（2.20周五收盘｜最高法院裁关税违宪利好）", us_market, MKT_BLUE)

    hk_market = news_data.get('hk_market', []) if news_data else [
        ("恒生指数", "26,413.35", "-1.10%", MKT_RED),
        ("恒生科技", "5,211.50", "-2.91%", MKT_RED),
        ("国企指数", "8,959.56", "-1.22%", MKT_RED),
    ]
    r.draw_info_card("港股主要指数（2.20周五收盘｜马年首个交易日 大年初四）", hk_market, CORAL)

    a_market = news_data.get('a_market', []) if news_data else [
        ("上证指数", "4,082.07", "-1.26%", MKT_RED),
        ("深证成指", "14,100.19", "-1.28%", MKT_RED),
        ("创业板指", "3,275.96", "-1.57%", MKT_RED),
        ("北证 50", "1,529.77", "-0.22%", MKT_RED),
    ]
    r.draw_info_card("A股主要指数（2.13周五收盘｜蛇年最后交易日 节前避险）", a_market, ORANGE)

    # ── 重点个股追踪 ──
    r.draw_section_title("\u91cd\u70b9\u4e2a\u80a1\u8ffd\u8e2a")

    game_stocks = news_data.get('game_stocks', []) if news_data else [
        ("TCEHY 腾讯ADR", "$68.05", "±0.0%", MKT_BLUE),
        ("0700.HK 腾讯", "HK$592.50", "-1.74%", MKT_RED),
        ("9888.HK 百度", "--", "-6.0%+", MKT_RED),
        ("9988.HK 阿里", "HK$142.10", "-4.37%", MKT_RED),
        ("02513.HK 智谱", "HK$725.00", "+42.72%", MKT_GREEN),
        ("00100.HK MiniMax", "HK$970.00", "+14.52%", MKT_GREEN),
    ]
    r.draw_info_card("港股/中概 科技+AI重点个股（2.20收盘）", game_stocks, MKT_BLUE)

    # ── 核心洞察 ──
    r.draw_section_title("\u6838\u5fc3\u6d1e\u5bdf")

    insights = news_data.get('insights', []) if news_data else [
        {
            'category': '美股市场',
            'priority': 5,
            'color': MKT_BLUE,
            'thesis': '最高法院裁定关税违宪成利好，美股周五低开高走三大指数集体收涨',
            'detail': '2月20日（周五），美国联邦最高法院以6:3裁定特朗普依据《国际紧急经济权力法》(IEEPA)实施的大规模关税超出法定权限、违宪无效。消息公布后美股低开高走，道指收涨0.47%报49625.97点，纳指涨0.90%报22886.07点，标普涨0.69%报6909.51点。通信服务板块(+2.65%)和非必需消费品板块(+1.27%)领涨，能源和医疗微跌。本周累计：道指涨0.25%，纳指涨1.51%，标普涨1.07%。特朗普随后依据1974年贸易法签署10%全球进口新关税行政令（最多持续150天）。（来源：新华社、东方财富网 2026.02.21报道）',
            'impact': '关税违宪裁决短期利好全球贸易信心和出口导向型企业，但特朗普的新10%关税替代方案增添不确定性。标普年内涨幅仅0.2%，纳指年内仍累跌超2%，科技股承压未完全解除。',
            'action': '关注新10%关税的实际执行范围和豁免清单；留意科技股是否企稳回升。'
        },
        {
            'category': '港股市场',
            'priority': 5,
            'color': CORAL,
            'thesis': '马年首日港股三大指数下挫，但国产AI大模型"双雄"逆势暴涨创新高',
            'detail': '2月20日（大年初四）港股马年首个交易日，三大指数集体承压：恒指跌1.10%报26413.35点，恒生科技跌2.91%报5211.50点（五个月调整新低），国企指数跌1.22%。互联网科技股普跌：百度跌超6%、阿里跌4.91%、腾讯跌超2%。但国产AI大模型板块逆势爆发：智谱暴涨42.72%报725港元（2月累涨206%），MiniMax涨14.52%报970港元，两者市值双双冲破3000亿港元，接连超越携程、快手和京东市值。机器人概念也大涨：越疆涨21.4%、优必选涨超6%。全日成交1653.73亿港元。（来源：东方财富网、36氪、智通财经 2026.02.20）',
            'impact': '港股呈"冰火两重天"格局：传统科技巨头遭受估值回调压力（美国AI板块回调传导+流动性承压），而AI大模型和机器人新势力获得极端追捧。智谱GLM-5发布后供不应求主动涨价30%，体现AI基建层的定价权正在确立。蛇年恒指全年涨32%的高基数也增加了回调压力。',
            'action': '关注节后A股开市（2.24）港股联动方向；AI大模型股短期涨幅巨大，注意波动风险。'
        },
        {
            'category': 'A股市场',
            'priority': 4,
            'color': ORANGE,
            'thesis': '蛇年收官日节前避险情绪释放，A股三大指数集体收跌，2万亿成交缩量',
            'detail': '2月13日（周五）为A股蛇年最后一个交易日，三大指数集体收跌：上证指数跌1.26%报4082.07点，深证成指跌1.28%报14100.19点，创业板指跌1.57%报3275.96点，北证50跌0.22%。全市场成交约2万亿元（较前日缩量约1600亿），超3800只个股下跌，赚钱效应仅28.68%。AI应用、太空光伏等前期热点遭调整。A股2月14日至2月23日休市（10天），2月24日（周二大年初八）开市。蛇年全年上证累涨25.58%，创业板累涨49.57%，科创50涨35.92%。（来源：同花顺、东方财富网、今日头条 2026.02.13-14）',
            'impact': '节前缩量下跌属于季节性避险行为而非趋势性转向。春节期间海外市场多项重大事件（最高法院关税裁决、中东局势升温、美伊紧张、黄金突破5000美元、港股AI大模型爆发）将在节后集中反映到A股定价中。机构普遍判断科技成长仍是2026年投资主线。',
            'action': '重点关注2.24节后开市首日的补涨/补跌行情，特别是AI、机器人、游戏等科技板块的方向选择。'
        },
        {
            'category': '全球政经',
            'priority': 5,
            'color': MKT_GOLD,
            'thesis': '地缘风险急升：美伊紧张局势+黄金突破5000美元+关税政策剧变',
            'detail': '三大全球宏观变量同时激化：1）美国最高法院2.20裁定关税违宪，特朗普立即以1974年贸易法另征10%新关税，贸易政策进入新一轮法律博弈期；2）特朗普2.20确认正考虑对伊朗"初步的有限军事打击"，美军已在波斯湾部署双航母战斗群，中东地缘风险急剧升温；3）受避险情绪推动，现货黄金2月以来多次突破5000美元/盎司（2.19报5014.62美元），白银单日涨超8%，贵金属价格创历史新高。此外，谷歌Gemini 3.1 Pro于2.20发布，推理性能翻倍。（来源：网易新闻、搜狐财经、东方财富网 2026.02.20-21）',
            'impact': '三重宏观冲击叠加：关税不确定性影响全球贸易预期、中东地缘风险推升能源和黄金价格、AI技术突破持续重塑产业格局。春节期间积累的海外风险溢价将在A股开市后集中释放，资金可能涌向确定性更高的避险和科技赛道。',
            'action': '做好节后A股首日波动加大的准备；关注黄金/原油对冲持仓；评估关税政策变化对出口型企业的影响。'
        },
    ]
    for item in insights:
        r.draw_insight_card(item)

    # ── 关键事件 ──
    r.draw_section_title("\u5173\u952e\u4e8b\u4ef6")

    events = news_data.get('events', []) if news_data else [
        ("2.20", "美最高法院6:3裁定特朗普IEEPA关税违宪，美股低开高走三大指数收涨", "新华社/东方财富网", "涉及1750亿+美元关税合法性，特朗普随即签署10%新关税令", MKT_GREEN),
        ("2.20", "特朗普确认考虑对伊朗进行'有限军事打击'，双航母部署波斯湾", "东方财富网", "中东地缘风险急升，避险资产全线走强", MKT_RED),
        ("2.20", "港股智谱暴涨42.72%、MiniMax涨14.52%，市值双双破3000亿港元", "36氪/智通财经", "GLM-5供不应求涨价30%，AI大模型定价权确立", MKT_GREEN),
        ("2.20", "谷歌Gemini 3.1 Pro发布，ARC-AGI-2推理得分77.1%性能翻倍", "东方财富网", "AI技术突破加速，行业竞争格局持续重塑", MKT_BLUE),
        ("2.19", "现货黄金站上5000美元/盎司（报5014.62美元），白银涨超2%", "证券之星/搜狐", "地缘政治+美元回调推升避险需求，金价创历史新高", MKT_GOLD),
        ("2.13", "A股蛇年收官：上证跌1.26%报4082点，超3800只个股下跌", "同花顺/今日头条", "节前避险情绪集中释放，2万亿成交缩量1600亿", MKT_RED),
    ]
    r.draw_timeline(events)

    # ── 行动建议 ──
    r.draw_section_title("\u7acb\u5373\u884c\u52a8")

    actions = news_data.get('actions', []) if news_data else [
        ("P0", "做好2.24（周二）A股节后开市首日波动预案，关注AI/机器人/游戏板块方向", "投资部", "2.24开市前", MKT_RED),
        ("P0", "评估美国10%新关税对出口型重仓标的的影响，必要时对冲", "风控部", "当日", MKT_RED),
        ("P1", "跟踪港股AI大模型（智谱/MiniMax）高位波动风险，评估仓位", "港股组", "本周", MKT_BLUE),
        ("P1", "关注黄金/原油避险持仓，评估中东局势升级对能源板块的传导", "大类资产组", "本周", MKT_GOLD),
        ("P2", "研究节后科技成长 vs 业绩风格转换的机构分歧，确定Q2配置方向", "策略部", "本月", MKT_BLUE),
    ]
    r.draw_actions(actions)

    r.draw_footer("数据: 新华社 + 东方财富网 + 同花顺 + 36氪 + 搜狐财经（实时验证）  |  二级市场监控 · 每日速递  |  2026.02.21")
    r.save()
    return filename


if __name__ == "__main__":
    f = generate()
    print(f"\n{'='*60}")
    print(f"\u5de5\u4f5c\u6d41 4: \u4e8c\u7ea7\u5e02\u573a\u76d1\u63a7")
    print(f"\u9891\u7387: \u6bcf\u65e5\uff08\u4ea4\u6613\u65e5\uff09")
    print(f"\u4ea7\u51fa: {f}")
    print(f"{'='*60}")
    print("\n\u5173\u6ce8\u7ef4\u5ea6 (MECE):")
    print("  \u2460 \u7f8e\u80a1 - \u4e09\u5927\u6307\u6570/\u91cd\u70b9\u79d1\u6280\u80a1/AI\u677f\u5757")
    print("  \u2461 \u6e2f\u80a1 - \u6052\u6307/\u6052\u79d1/\u5357\u5411\u8d44\u91d1")
    print("  \u2462 A\u80a1 - \u4e0a\u8bc1/\u6df1\u8bc1/\u521b\u4e1a\u677f/\u79d1\u521b")
    print("  \u2463 \u5168\u7403\u653f\u7ecf - \u4e2d\u7f8e/\u8d38\u6613/\u5730\u7f18/\u592e\u884c/\u5927\u5b97")
